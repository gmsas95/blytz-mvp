events {
    worker_connections 1024;
}

http {
    # Dokploy-compatible nginx configuration for external access

    # Map subdomains to internal services
    map $host $backend_service {
        blytz.app               blytz-frontend-prod:3000;
        www.blytz.app           blytz-frontend-prod:3000;
        api.blytz.app           blytz-gateway-prod:8080;
        auth.blytz.app          blytz-auth-prod:8084;
        auction.blytz.app       blytz-auction-prod:8083;
        products.blytz.app      blytz-product-prod:8082;
        orders.blytz.app        blytz-order-prod:8085;
        payments.blytz.app      blytz-payment-prod:8086;
        chat.blytz.app          blytz-chat-prod:8088;
        logistics.blytz.app     blytz-logistics-prod:8087;
        monitor.blytz.app       blytz-prometheus-prod:9090;
        analytics.blytz.app     blytz-grafana-prod:3000;
        status.blytz.app        status;
    }

    # Default server for main domain and subdomains
    server {
        listen 80;
        server_name
            blytz.app
            www.blytz.app
            api.blytz.app
            auth.blytz.app
            auction.blytz.app
            products.blytz.app
            orders.blytz.app
            payments.blytz.app
            chat.blytz.app
            logistics.blytz.app
            monitor.blytz.app
            analytics.blytz.app
            status.blytz.app;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Handle status subdomain specially
        location / {
            # Route based on host header
            if ($host = "status.blytz.app") {
                return 200 '{
                    "status": "operational",
                    "services": {
                        "frontend": "https://blytz.app",
                        "api": "https://api.blytz.app",
                        "auth": "https://auth.blytz.app",
                        "auction": "https://auction.blytz.app",
                        "products": "https://products.blytz.app",
                        "orders": "https://orders.blytz.app",
                        "payments": "https://payments.blytz.app",
                        "chat": "https://chat.blytz.app",
                        "logistics": "https://logistics.blytz.app",
                        "monitoring": "https://monitor.blytz.app",
                        "analytics": "https://analytics.blytz.app"
                    },
                    "timestamp": "2025-10-21T01:30:00Z"
                }';
                add_header Content-Type application/json;
            }

            # Frontend service
            if ($host ~ "^(www\.)?blytz\.app$") {
                proxy_pass http://blytz-frontend-prod:3000;
            }

            # Auth service (port 8084 is exposed)
            if ($host = "auth.blytz.app") {
                proxy_pass http://blytz-auth-prod:8084;
            }

            # API Gateway
            if ($host = "api.blytz.app") {
                proxy_pass http://blytz-gateway-prod:8080;
            }

            # Auction Service
            if ($host = "auction.blytz.app") {
                proxy_pass http://blytz-auction-prod:8083;
            }

            # Product Service
            if ($host = "products.blytz.app") {
                proxy_pass http://blytz-product-prod:8082;
            }

            # Order Service
            if ($host = "orders.blytz.app") {
                proxy_pass http://blytz-order-prod:8085;
            }

            # Payment Service
            if ($host = "payments.blytz.app") {
                proxy_pass http://blytz-payment-prod:8086;
            }

            # Chat Service
            if ($host = "chat.blytz.app") {
                proxy_pass http://blytz-chat-prod:8088;
            }

            # Logistics Service
            if ($host = "logistics.blytz.app") {
                proxy_pass http://blytz-logistics-prod:8087;
            }

            # Monitoring - Prometheus
            if ($host = "monitor.blytz.app") {
                proxy_pass http://blytz-prometheus-prod:9090;
            }

            # Analytics - Grafana
            if ($host = "analytics.blytz.app") {
                proxy_pass http://blytz-grafana-prod:3000;
            }

            # Common proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # CORS headers for API services
            if ($host ~ "\.(api|auth|auction|products|orders|payments|chat|logistics)\.blytz\.app$") {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;

                # Handle preflight requests
                if ($request_method = 'OPTIONS') {
                    add_header 'Access-Control-Allow-Origin' '*';
                    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
                    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
                    add_header 'Access-Control-Max-Age' 1728000;
                    add_header 'Content-Type' 'text/plain; charset=utf-8';
                    add_header 'Content-Length' 0;
                    return 204;
                }
            }
        }
    }
}